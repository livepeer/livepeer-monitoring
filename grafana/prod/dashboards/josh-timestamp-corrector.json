{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "panels": [
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Dashboard --"
      },
      "description": "All known valid corrections",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 0,
        "y": 0
      },
      "id": 6,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "count"
          ],
          "fields": "/^request_id$/",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.1.1",
      "targets": [
        {
          "datasource": {
            "type": "datasource",
            "uid": "-- Dashboard --"
          },
          "panelId": 1,
          "refId": "A",
          "withTransforms": true
        }
      ],
      "title": "Corrections",
      "transformations": [
        {
          "id": "filterByValue",
          "options": {
            "filters": [
              {
                "config": {
                  "id": "equal",
                  "options": {
                    "value": "true"
                  }
                },
                "fieldName": "recognized_ua"
              },
              {
                "config": {
                  "id": "equal",
                  "options": {
                    "value": "true"
                  }
                },
                "fieldName": "corrected"
              },
              {
                "config": {
                  "id": "equal",
                  "options": {
                    "value": "true"
                  }
                },
                "fieldName": "estimated_broken"
              }
            ],
            "match": "all",
            "type": "include"
          }
        }
      ],
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Dashboard --"
      },
      "description": "Should have applied TS correction but didn't",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 4,
        "y": 0
      },
      "id": 2,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "count"
          ],
          "fields": "/^request_id$/",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.1.1",
      "targets": [
        {
          "datasource": {
            "type": "datasource",
            "uid": "-- Dashboard --"
          },
          "panelId": 1,
          "refId": "A",
          "withTransforms": true
        }
      ],
      "title": "False Negatives",
      "transformations": [
        {
          "id": "filterByValue",
          "options": {
            "filters": [
              {
                "config": {
                  "id": "equal",
                  "options": {
                    "value": "false"
                  }
                },
                "fieldName": "corrected"
              },
              {
                "config": {
                  "id": "equal",
                  "options": {
                    "value": "true"
                  }
                },
                "fieldName": "estimated_broken"
              }
            ],
            "match": "all",
            "type": "include"
          }
        }
      ],
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Dashboard --"
      },
      "description": "Should not have applied TS correction",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 8,
        "y": 0
      },
      "id": 3,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "count"
          ],
          "fields": "/^request_id$/",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.1.1",
      "targets": [
        {
          "datasource": {
            "type": "datasource",
            "uid": "-- Dashboard --"
          },
          "panelId": 1,
          "refId": "A",
          "withTransforms": true
        }
      ],
      "title": "False Positives",
      "transformations": [
        {
          "id": "filterByValue",
          "options": {
            "filters": [
              {
                "config": {
                  "id": "equal",
                  "options": {
                    "value": "true"
                  }
                },
                "fieldName": "corrected"
              },
              {
                "config": {
                  "id": "equal",
                  "options": {
                    "value": "false"
                  }
                },
                "fieldName": "estimated_broken"
              }
            ],
            "match": "all",
            "type": "include"
          }
        }
      ],
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Dashboard --"
      },
      "description": "Heuristics triggered but TS correction not applied because device was not broken",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 12,
        "y": 0
      },
      "id": 4,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "count"
          ],
          "fields": "/^request_id$/",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.1.1",
      "targets": [
        {
          "datasource": {
            "type": "datasource",
            "uid": "-- Dashboard --"
          },
          "panelId": 1,
          "refId": "A",
          "withTransforms": true
        }
      ],
      "title": "Disasters Averted",
      "transformations": [
        {
          "id": "filterByValue",
          "options": {
            "filters": [
              {
                "config": {
                  "id": "equal",
                  "options": {
                    "value": "true"
                  }
                },
                "fieldName": "detected"
              },
              {
                "config": {
                  "id": "equal",
                  "options": {
                    "value": "false"
                  }
                },
                "fieldName": "corrected"
              },
              {
                "config": {
                  "id": "equal",
                  "options": {
                    "value": "false"
                  }
                },
                "fieldName": "estimated_broken"
              }
            ],
            "match": "all",
            "type": "include"
          }
        }
      ],
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Dashboard --"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            },
            "inspect": false
          },
          "mappings": [],
          "noValue": "Empty - All UAs Recognized",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 15,
        "x": 0,
        "y": 4
      },
      "id": 5,
      "options": {
        "cellHeight": "sm",
        "footer": {
          "countRows": false,
          "fields": "",
          "reducer": [
            "sum"
          ],
          "show": false
        },
        "showHeader": true
      },
      "pluginVersion": "12.1.1",
      "targets": [
        {
          "datasource": {
            "type": "datasource",
            "uid": "-- Dashboard --"
          },
          "panelId": 1,
          "refId": "A",
          "withTransforms": true
        }
      ],
      "title": "Unrecognized User Agents",
      "transformations": [
        {
          "id": "filterByValue",
          "options": {
            "filters": [
              {
                "config": {
                  "id": "notEqual",
                  "options": {
                    "value": "true"
                  }
                },
                "fieldName": "recognized_ua"
              }
            ],
            "match": "any",
            "type": "include"
          }
        },
        {
          "id": "filterFieldsByName",
          "options": {
            "include": {
              "pattern": "^ua$|request_id"
            }
          }
        },
        {
          "id": "groupBy",
          "options": {
            "fields": {
              "request_id": {
                "aggregations": [
                  "count"
                ],
                "operation": "aggregate"
              },
              "ua": {
                "aggregations": [
                  "count"
                ],
                "operation": "groupby"
              }
            }
          }
        }
      ],
      "type": "table"
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "P8E80F9AEF21F6940"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "applyToRow": true,
              "type": "color-background"
            },
            "filterable": true,
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "transparent",
                "value": 0
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Unintended Change"
            },
            "properties": [
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "transparent",
                      "value": 0
                    },
                    {
                      "color": "red",
                      "value": 1
                    }
                  ]
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 18,
        "x": 0,
        "y": 10
      },
      "id": 1,
      "options": {
        "cellHeight": "sm",
        "footer": {
          "countRows": false,
          "fields": "",
          "reducer": [
            "sum"
          ],
          "show": false
        },
        "showHeader": true,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Unintended Change"
          }
        ]
      },
      "pluginVersion": "12.1.1",
      "targets": [
        {
          "datasource": {
            "type": "loki",
            "uid": "P8E80F9AEF21F6940"
          },
          "direction": "backward",
          "editorMode": "code",
          "expr": "{container=\"ai-gateway\"} |= `user-agent`\n| regexp `user-agent=(?P<uaRaw>.*)$`\n| regexp `request_id=(?P<request_id>[a-z0-9]+)`\n# device buckets\n| regexp `(?P<device>iPhone|Macintosh|Windows NT|X11; Linux x86_64|Linux; Android|Linux x86_64|Windows x86_64|iPad|Lavf)`\n# browser/version extracts (each stage is small & optional)\n| regexp `(?:Chrome|CriOS)/(?P<chrome_ver>\\d+)`\n| regexp `Firefox/(?P<ff_ver>\\d+)`\n| regexp `Version/(?P<safari_ver>\\d+(?:\\.\\d+){0,2})`\n| regexp `OPR/(?P<opr_ver>\\d+)`\n| regexp `HeadlessChrome/(?P<headless_ver>\\d+)`\n| regexp `Lavf/(?P<lavf_ver>\\d+\\.\\d+\\.\\d+)`\n| regexp `OBS-Studio/(?P<obs_ver>\\d+\\.\\d+\\.\\d+)`\n| regexp `Brave/(?P<brave_ver>\\d+)`\n# iOS version (for iPhone)\n| regexp `iPhone OS (?P<ios_ver>\\d+(?:_\\d+){0,2})`\n# normalize fields\n| label_format browser=`{{ if .chrome_ver }}Chrome{{ else if .ff_ver }}Firefox{{ else if .safari_ver }}Safari{{ else if .opr_ver }}Opera{{ else if .headless_ver }}Headless Chrome{{ else if .lavf_ver }}FFmpeg{{ else if .obs_ver }}OBS{{ else if .brave_ver }}Brave{{ else }}Other{{ end }}`\n| label_format ver=`{{ if .chrome_ver }}{{ .chrome_ver }}{{ else if .ff_ver }}{{ .ff_ver }}{{ else if .safari_ver }}{{ .safari_ver }}{{ else if .opr_ver }}{{ .opr_ver }}{{ else if .headless_ver }}{{ .headless_ver }}{{ else if .lavf_ver }}{{ .lavf_ver }}{{ else if .obs_ver }}{{ .obs_ver }}{{ else }}unknown{{ end }}`\n| label_format ios_ver=`{{ if .ios_ver }}{{ regexReplaceAll \"_\" .ios_ver \".\" }}{{ end }}`\n| label_format device=`{{ if eq .device \"Linux; Android\" }}Android{{ else if contains \"Linux\" .device }}Linux{{ else if contains \"Windows\" .device }}Windows{{ else }}{{ .device }}{{ end }}`\n# build your compact UA label\n| label_format platform=`{{ if eq .device \"iPhone\" }}iPhone {{ .ios_ver }}{{ else if eq .device \"Macintosh\" }}Mac{{ else if eq .device \"Windows\" }}Win{{ else if eq .device \"Linux\" }}Linux{{ else if eq .device \"Android\" }}Android{{ else if eq .device \"iPad\" }}iPad{{ else if .lavf_ver }}{{ else }}UNK - {{.uaRaw}}{{ end }}`\n| label_format ua=`{{.platform}} {{ .browser }} {{ .ver }}`\n# flags\n# NB: Some Mac Safari 18.4 *might* actually be broken!\n# But this occurs during a minor update and it doesn't seem possible to distinguish between versions\n| label_format broken_ua=`{{ if and (eq .device \"Macintosh\") (eq .browser \"Safari\") (contains .ver \"18.5\") }}true{{ else if and (eq .device \"iPhone\") (contains \"18.5\" .ios_ver ) }}true{{ else }}false{{ end }}`\n| label_format recognized_ua=`{{ if eq .browser \"Other\" }}false{{ else }}true{{ end }}`\n# fall back to raw if we couldn't ID it\n| label_format ua=`{{ if eq .browser \"Other\" }}{{ .uaRaw }}{{ else }}{{ .ua }}{{ end }}`\n| line_format `request_id={{.request_id}} ua=\"{{.ua}}\" estimated_broken={{.broken_ua}} recognized_ua={{.recognized_ua}}`\n",
          "hide": false,
          "maxLines": 5000,
          "queryType": "range",
          "refId": "User Agents"
        },
        {
          "datasource": {
            "type": "loki",
            "uid": "P8E80F9AEF21F6940"
          },
          "direction": "backward",
          "editorMode": "builder",
          "expr": "{container=\"ai-gateway\"} |= `TSCorrector: All good` | logfmt --strict request_id, freq, first, delta, dt_ms | line_format `request_id={{.request_id}} detected=false corrected=false first={{.first}} delta={{.delta}} dt_ms={{.dt_ms}}`",
          "hide": false,
          "maxLines": 5000,
          "queryType": "range",
          "refId": "All good timings"
        },
        {
          "datasource": {
            "type": "loki",
            "uid": "P8E80F9AEF21F6940"
          },
          "direction": "backward",
          "editorMode": "builder",
          "expr": "{container=\"ai-gateway\"} |= `TSCorrector: Frequency too high` | logfmt --strict request_id, first, delta, dt_ms, skipping | label_format skipped=skipping | line_format `request_id={{.request_id}} detected=true corrected={{if eq \"true\" .skipped}}false{{else}}true{{end}} first={{.first}} delta={{.delta}} dt_ms={{.dt_ms}}`",
          "hide": false,
          "maxLines": 5000,
          "queryType": "range",
          "refId": "Skipped timings"
        }
      ],
      "title": "Timestamp Corrections",
      "transformations": [
        {
          "id": "extractFields",
          "options": {
            "delimiter": ",",
            "format": "kvp",
            "replace": true,
            "source": "Line"
          }
        },
        {
          "id": "joinByField",
          "options": {
            "byField": "request_id",
            "mode": "outer"
          }
        },
        {
          "id": "calculateField",
          "options": {
            "alias": "detected",
            "mode": "reduceRow",
            "reduce": {
              "include": [
                "detected 1",
                "detected 2"
              ],
              "reducer": "firstNotNull"
            },
            "replaceFields": false
          }
        },
        {
          "id": "calculateField",
          "options": {
            "alias": "first",
            "mode": "reduceRow",
            "reduce": {
              "include": [
                "first 1",
                "first 2"
              ],
              "reducer": "firstNotNull"
            }
          }
        },
        {
          "id": "calculateField",
          "options": {
            "alias": "delta",
            "mode": "reduceRow",
            "reduce": {
              "include": [
                "delta 1",
                "delta 2"
              ],
              "reducer": "firstNotNull"
            }
          }
        },
        {
          "id": "calculateField",
          "options": {
            "alias": "dt_ms",
            "mode": "reduceRow",
            "reduce": {
              "include": [
                "dt_ms 1",
                "dt_ms 2"
              ],
              "reducer": "firstNotNull"
            }
          }
        },
        {
          "id": "calculateField",
          "options": {
            "alias": "corrected",
            "mode": "reduceRow",
            "reduce": {
              "include": [
                "corrected 1",
                "corrected 2"
              ],
              "reducer": "firstNotNull"
            }
          }
        },
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              "corrected 1": true,
              "corrected 2": true,
              "delta 1": true,
              "delta 2": true,
              "detected 1": true,
              "detected 2": true,
              "dt_ms 1": true,
              "dt_ms 2": true,
              "first 1": true,
              "first 2": true
            },
            "includeByName": {},
            "indexByName": {
              "corrected": 12,
              "corrected 1": 8,
              "corrected 2": 6,
              "delta": 17,
              "delta 1": 10,
              "delta 2": 4,
              "detected": 13,
              "detected 1": 7,
              "detected 2": 2,
              "dt_ms": 18,
              "dt_ms 1": 11,
              "dt_ms 2": 5,
              "estimated_broken": 14,
              "first": 16,
              "first 1": 9,
              "first 2": 3,
              "recognized_ua": 15,
              "request_id": 0,
              "ua": 1
            },
            "renameByName": {
              "corrected 3": "corrected",
              "delta 3": "delta",
              "detected 3": "detected",
              "dt_ms 3": "dt_ms",
              "first 3": "first"
            }
          }
        },
        {
          "id": "filterByValue",
          "options": {
            "filters": [
              {
                "config": {
                  "id": "isNull",
                  "options": {}
                },
                "fieldName": "detected"
              }
            ],
            "match": "all",
            "type": "exclude"
          }
        },
        {
          "id": "calculateField",
          "options": {
            "alias": "Unintended Change",
            "mode": "reduceRow",
            "reduce": {
              "include": [
                "corrected",
                "estimated_broken"
              ],
              "reducer": "changeCount"
            }
          }
        }
      ],
      "type": "table"
    }
  ],
  "preload": false,
  "schemaVersion": 41,
  "tags": [],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "utc",
  "title": "Josh - Timestamp Corrector",
  "uid": "cep5qbgj67jeoa",
  "version": 12
}
